// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Customer {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  name         String?
  phone        String?
  isActive     Boolean   @default(true)
  bookings     Booking[] @relation("BookingCustomer")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Admin {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String
  name              String?
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model Staff {
  id                String             @id @default(uuid())
  email             String             @unique
  passwordHash      String
  name              String?
  isActive          Boolean            @default(true)
  assignedStore     Store              @relation("StaffAssignment", fields: [assignedStoreId], references: [id])
  assignedStoreId   String
  createdBookings   Booking[]          @relation("StaffBookingCreator")
  confirmedBookings Booking[]          @relation("StaffBookingConfirmer")
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

model Store {
  id                String             @id @default(uuid())
  name              String
  address           String?
  isActive          Boolean            @default(true)
  assignedStaff     Staff[]            @relation("StaffAssignment")
  rooms             Room[]
  bookings          Booking[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

model RoomType {
  id          String    @id @default(uuid())
  name        String    @unique // 房型名称全局唯一：标准间、大床房、套房等
  description String? // 房型描述
  basePrice   Decimal   @db.Decimal(12, 2) // 建议基础价格（各房间可覆盖）
  capacity    Int       @default(2) // 建议最大入住人数
  amenities   String[]  @default([]) // 房型标准设施配置
  isActive    Boolean   @default(true) // 是否启用
  rooms       Room[]
  bookings    Booking[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Room {
  id                String                @id @default(uuid())
  roomNo            String
  floor             Int // 楼层号
  capacity          Int                   @default(1)
  basePrice         Decimal               @db.Decimal(12, 2)
  status            RoomOperationalStatus @default(AVAILABLE)
  isActive          Boolean               @default(true)
  store             Store                 @relation(fields: [storeId], references: [id])
  storeId           String
  roomType          RoomType              @relation(fields: [roomTypeId], references: [id])
  roomTypeId        String
  bookingRooms      BookingRoom[]
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  @@unique([storeId, roomNo])
}

model Booking {
  id                 String         @id @default(uuid())
  status             BookingStatus  @default(PENDING)
  checkIn            DateTime
  checkOut           DateTime
  totalPrice         Decimal        @db.Decimal(14, 2)
  createdByRole      BookingCreator @default(CUSTOMER)
  cancelReason       String?
  cancelledAt        DateTime?
  confirmedByStaff   Staff?         @relation("StaffBookingConfirmer", fields: [confirmedByStaffId], references: [id])
  confirmedByStaffId String?
  checkedInAt        DateTime?
  checkedOutAt       DateTime?
  customer           Customer?      @relation("BookingCustomer", fields: [customerId], references: [id])
  customerId         String?
  createdByStaff     Staff?         @relation("StaffBookingCreator", fields: [createdByStaffId], references: [id])
  createdByStaffId   String?
  store              Store          @relation(fields: [storeId], references: [id])
  storeId            String
  roomType           RoomType?      @relation(fields: [roomTypeId], references: [id])
  roomTypeId         String?
  bookingRooms       BookingRoom[]
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  @@index([storeId, status])
  @@index([checkIn, checkOut])
}

model BookingRoom {
  id          String   @id @default(uuid())
  booking     Booking  @relation(fields: [bookingId], references: [id])
  bookingId   String
  room        Room     @relation(fields: [roomId], references: [id])
  roomId      String
  nightlyRate Decimal? @db.Decimal(12, 2)

  @@unique([bookingId, roomId])
  @@index([roomId])
}

enum RoomOperationalStatus {
  AVAILABLE     // 空闲 - 可以预订
  OCCUPIED      // 占用 - 已被预订/入住
  CLEANING         // 待清洁 - 客人离店后需要清洁
  OUT_OF_SERVICE // 停用 - 管理员手动设置
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
}

enum BookingCreator {
  CUSTOMER
  STAFF
}

