// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                Int                @id @default(autoincrement())
  email             String             @unique
  passwordHash      String
  name              String?
  role              UserRole           @default(CUSTOMER)
  isActive          Boolean            @default(true)
  bookings          Booking[]          @relation("BookingCustomer")
  createdBookings   Booking[]          @relation("BookingCreator")
  confirmedBookings Booking[]          @relation("BookingConfirmer")
  housekeepingTasks HousekeepingTask[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

model Store {
  id                Int                @id @default(autoincrement())
  name              String
  address           String?
  isActive          Boolean            @default(true)
  floors            Floor[]
  rooms             Room[]
  bookings          Booking[]
  housekeepingTasks HousekeepingTask[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

model Floor {
  id        Int      @id @default(autoincrement())
  name      String
  level     Int?
  store     Store    @relation(fields: [storeId], references: [id])
  storeId   Int
  rooms     Room[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, name])
}

model Room {
  id                Int                   @id @default(autoincrement())
  roomNo            String
  capacity          Int                   @default(1)
  basePrice         Decimal               @db.Decimal(12, 2)
  status            RoomOperationalStatus @default(AVAILABLE)
  isActive          Boolean               @default(true)
  store             Store                 @relation(fields: [storeId], references: [id])
  storeId           Int
  floor             Floor                 @relation(fields: [floorId], references: [id])
  floorId           Int
  bookingRooms      BookingRoom[]
  housekeepingTasks HousekeepingTask[]
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  @@unique([storeId, roomNo])
}

model Booking {
  id                Int            @id @default(autoincrement())
  status            BookingStatus  @default(PENDING)
  checkIn           DateTime
  checkOut          DateTime
  totalPrice        Decimal        @db.Decimal(14, 2)
  createdByRole     BookingCreator @default(CUSTOMER)
  cancelReason      String?
  cancelledAt       DateTime?
  confirmedByUser   User?          @relation("BookingConfirmer", fields: [confirmedByUserId], references: [id])
  confirmedByUserId Int?
  checkedInAt       DateTime?
  checkedOutAt      DateTime?
  customer          User?          @relation("BookingCustomer", fields: [customerId], references: [id])
  customerId        Int?
  createdByUser     User?          @relation("BookingCreator", fields: [createdByUserId], references: [id])
  createdByUserId   Int?
  store             Store          @relation(fields: [storeId], references: [id])
  storeId           Int
  bookingRooms      BookingRoom[]
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([storeId, status])
  @@index([checkIn, checkOut])
}

model BookingRoom {
  id          Int      @id @default(autoincrement())
  booking     Booking  @relation(fields: [bookingId], references: [id])
  bookingId   Int
  room        Room     @relation(fields: [roomId], references: [id])
  roomId      Int
  nightlyRate Decimal? @db.Decimal(12, 2)

  @@unique([bookingId, roomId])
  @@index([roomId])
}

model HousekeepingTask {
  id           Int                    @id @default(autoincrement())
  type         HousekeepingTaskType   @default(CLEANING)
  status       HousekeepingTaskStatus @default(OPEN)
  room         Room                   @relation(fields: [roomId], references: [id])
  roomId       Int
  store        Store?                 @relation(fields: [storeId], references: [id])
  storeId      Int?
  assignedTo   User?                  @relation(fields: [assignedToId], references: [id])
  assignedToId Int?
  notes        String?
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
}

enum UserRole {
  CUSTOMER
  STAFF
  ADMIN
}

enum RoomOperationalStatus {
  AVAILABLE
  OCCUPIED
  DIRTY
  CLEANING
  MAINTENANCE
  LOCKED
  OUT_OF_SERVICE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  CHECKED_OUT
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum BookingCreator {
  CUSTOMER
  STAFF
  ADMIN
}

enum HousekeepingTaskType {
  CLEANING
  INSPECTION
}

enum HousekeepingTaskStatus {
  OPEN
  IN_PROGRESS
  DONE
}
